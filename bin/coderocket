#!/bin/bash

# CodeRocket å…¨å±€å‘½ä»¤è„šæœ¬
# æ”¯æŒå¤šç§å‘½ä»¤åˆ«åï¼šcoderocket, codereview-cli, cr

# è·å–å½“å‰å‘½ä»¤åç§°ï¼ˆç”¨äºæ˜¾ç¤ºå…¼å®¹æ€§ä¿¡æ¯ï¼‰
CURRENT_CMD=$(basename "$0")

# å®‰è£…ç›®å½•
INSTALL_DIR="$HOME/.coderocket"

# è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# å¯¼å…¥ banner æ˜¾ç¤ºå‡½æ•°
if [ -f "$INSTALL_DIR/lib/banner.sh" ]; then
    source "$INSTALL_DIR/lib/banner.sh"
elif [ -f "$PROJECT_DIR/lib/banner.sh" ]; then
    source "$PROJECT_DIR/lib/banner.sh"
elif [ -f "./lib/banner.sh" ]; then
    source "./lib/banner.sh"
fi

# æ£€æŸ¥æ˜¯å¦åœ¨ Git ä»“åº“ä¸­
is_git_repo() {
    git rev-parse --git-dir > /dev/null 2>&1
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    if declare -f show_mini_banner &> /dev/null; then
        show_mini_banner
    else
        echo "CodeRocket ğŸš€ - AI é©±åŠ¨çš„ä»£ç å®¡æŸ¥å·¥å…·"
    fi
    echo ""
    echo "ç”¨æ³•ï¼š"
    echo "  $CURRENT_CMD [å‘½ä»¤] [é€‰é¡¹]"
    echo ""
    echo "å…¼å®¹å‘½ä»¤ï¼š"
    echo "  coderocket, codereview-cli, cr éƒ½å¯ä»¥ä½¿ç”¨"
    echo ""
    echo "å‘½ä»¤ï¼š"
    echo "  review          å®¡æŸ¥æœ€æ–°æäº¤ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰"
    echo "  setup           ä¸ºå½“å‰é¡¹ç›®è®¾ç½® CodeRocket"
    echo "  config          é…ç½® AI æœåŠ¡"
    echo "  timing          é…ç½®ä»£ç å®¡æŸ¥æ—¶æœº"
    echo "  update          æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬"
    echo "  version         æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo "  help            æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
    echo ""
    echo "ç¤ºä¾‹ï¼š"
    echo "  $CURRENT_CMD                # åœ¨ Git ä»“åº“ä¸­ç›´æ¥å®¡æŸ¥"
    echo "  $CURRENT_CMD setup          # è®¾ç½®å½“å‰é¡¹ç›®"
    echo "  $CURRENT_CMD config         # é…ç½® AI æœåŠ¡"
    echo ""
}

# æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
show_version() {
    if declare -f show_mini_banner &> /dev/null; then
        show_mini_banner
    else
        echo "CodeRocket ğŸš€"
    fi
    echo ""
    if [ -f "$INSTALL_DIR/VERSION" ]; then
        echo "ç‰ˆæœ¬: $(cat "$INSTALL_DIR/VERSION")"
    else
        echo "ç‰ˆæœ¬: v1.0.0"
    fi
    echo "å®‰è£…è·¯å¾„: $INSTALL_DIR"
    echo "å‘½ä»¤åˆ«å: coderocket, codereview-cli, cr"
}

# æ‰§è¡Œä»£ç å®¡æŸ¥
run_review() {
    # æ˜¾ç¤ºbanner
    if declare -f show_banner &> /dev/null; then
        show_banner
    elif declare -f show_mini_banner &> /dev/null; then
        show_mini_banner
    fi
    echo ""

    if ! is_git_repo; then
        if command -v show_error_banner &> /dev/null; then
            show_error_banner "å½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“"
        else
            echo "âŒ é”™è¯¯ï¼šå½“å‰ç›®å½•ä¸æ˜¯ Git ä»“åº“"
        fi
        echo "è¯·åœ¨ Git ä»“åº“ä¸­è¿è¡Œæ­¤å‘½ä»¤ï¼Œæˆ–ä½¿ç”¨ '$CURRENT_CMD setup' è®¾ç½®é¡¹ç›®ã€‚"
        exit 1
    fi

    echo "ğŸ” æ­£åœ¨å®¡æŸ¥æœ€æ–°æäº¤..."
    
    # æ£€æŸ¥æ˜¯å¦æœ‰ post-commit hook
    if [ -f ".git/hooks/post-commit" ]; then
        # ç›´æ¥æ‰§è¡Œ post-commit hook
        .git/hooks/post-commit
    else
        echo "âš ï¸  æœªæ‰¾åˆ° post-commit hookï¼Œè¯·å…ˆè¿è¡Œ '$CURRENT_CMD setup'"
        exit 1
    fi
}

# è®¾ç½®é¡¹ç›®
setup_project() {
    # æ˜¾ç¤ºbanner
    if declare -f show_mini_banner &> /dev/null; then
        show_mini_banner
    fi
    echo ""

    if [ -f "$INSTALL_DIR/install-hooks.sh" ]; then
        echo "ğŸ”§ æ­£åœ¨ä¸ºå½“å‰é¡¹ç›®è®¾ç½® CodeRocket..."
        bash "$INSTALL_DIR/install-hooks.sh"
    else
        echo "âŒ é”™è¯¯ï¼šå®‰è£…æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè¯·é‡æ–°å®‰è£… CodeRocket"
        exit 1
    fi
}

# é…ç½® AI æœåŠ¡
config_ai() {
    # æ˜¾ç¤ºbanner
    if declare -f show_mini_banner &> /dev/null; then
        show_mini_banner
    fi
    echo ""

    echo "ğŸ¤– AI æœåŠ¡é…ç½®"
    echo "è¯·ç¼–è¾‘é…ç½®æ–‡ä»¶: $INSTALL_DIR/env"
    echo "æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ï¼š"
    echo "  export GEMINI_API_KEY='your-api-key'"
    echo "  export AI_SERVICE='gemini'  # æˆ– opencode, claudecode"
    
    if command -v code &> /dev/null; then
        read -p "æ˜¯å¦ä½¿ç”¨ VS Code æ‰“å¼€é…ç½®æ–‡ä»¶ï¼Ÿ(y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            code "$INSTALL_DIR/env"
        fi
    fi
}

# é…ç½®å®¡æŸ¥æ—¶æœº
config_timing() {
    echo "â° ä»£ç å®¡æŸ¥æ—¶æœºé…ç½®"
    echo "1. post-commit: æäº¤åå®¡æŸ¥ï¼ˆæ¨èï¼‰"
    echo "2. pre-commit: æäº¤å‰å®¡æŸ¥"
    
    read -p "è¯·é€‰æ‹© (1/2): " -n 1 -r
    echo
    
    case $REPLY in
        1)
            export REVIEW_TIMING="post-commit"
            echo "å·²è®¾ç½®ä¸ºæäº¤åå®¡æŸ¥"
            ;;
        2)
            export REVIEW_TIMING="pre-commit"
            echo "å·²è®¾ç½®ä¸ºæäº¤å‰å®¡æŸ¥"
            ;;
        *)
            echo "æ— æ•ˆé€‰æ‹©"
            exit 1
            ;;
    esac
    
    # ä¿å­˜åˆ°é…ç½®æ–‡ä»¶
    if [ ! -f "$INSTALL_DIR/env" ]; then
        touch "$INSTALL_DIR/env"
    fi
    
    # æ›´æ–°æˆ–æ·»åŠ é…ç½®
    if grep -q "REVIEW_TIMING=" "$INSTALL_DIR/env"; then
        sed -i.bak "s/REVIEW_TIMING=.*/REVIEW_TIMING=$REVIEW_TIMING/" "$INSTALL_DIR/env"
    else
        echo "REVIEW_TIMING=$REVIEW_TIMING" >> "$INSTALL_DIR/env"
    fi
    
    echo "âœ… é…ç½®å·²ä¿å­˜åˆ° $INSTALL_DIR/env"
}

# æ›´æ–° CodeRocket
update_coderocket() {
    echo "ğŸ”„ æ­£åœ¨æ›´æ–° CodeRocket..."
    
    if [ -d "$INSTALL_DIR/.git" ]; then
        cd "$INSTALL_DIR"
        git pull origin main
        echo "âœ… æ›´æ–°å®Œæˆ"
    else
        echo "âš ï¸  å»ºè®®é‡æ–°è¿è¡Œå®‰è£…è„šæœ¬è·å–æœ€æ–°ç‰ˆæœ¬ï¼š"
        echo "curl -fsSL https://raw.githubusercontent.com/im47cn/coderocket/main/install.sh | bash"
    fi
}

# ä¸»é€»è¾‘
main() {
    case "${1:-}" in
        "review")
            run_review
            ;;
        "setup")
            setup_project
            ;;
        "config")
            config_ai
            ;;
        "timing")
            config_timing
            ;;
        "update")
            update_coderocket
            ;;
        "version")
            show_version
            ;;
        "help"|"-h"|"--help")
            show_help
            ;;
        "")
            # é»˜è®¤è¡Œä¸ºï¼šå¦‚æœåœ¨ Git ä»“åº“ä¸­åˆ™ç›´æ¥å®¡æŸ¥ï¼Œå¦åˆ™æ˜¾ç¤ºå¸®åŠ©
            if is_git_repo; then
                run_review
            else
                if command -v show_startup_info &> /dev/null; then
                    show_startup_info
                else
                    show_help
                fi
            fi
            ;;
        *)
            echo "âŒ æœªçŸ¥å‘½ä»¤: $1"
            echo "ä½¿ç”¨ '$CURRENT_CMD help' æŸ¥çœ‹å¯ç”¨å‘½ä»¤"
            exit 1
            ;;
    esac
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
