#!/bin/bash

# è·å– Git ä»“åº“æ ¹ç›®å½•
REPO_ROOT=$(git rev-parse --show-toplevel 2>/dev/null)

# å¦‚æœä¸åœ¨ Git ä»“åº“ä¸­ï¼Œé€€å‡º
if [ -z "$REPO_ROOT" ]; then
    echo "âŒ é”™è¯¯ï¼šä¸åœ¨ Git ä»“åº“ä¸­"
    exit 1
fi

# å®‰å…¨åœ°åŠ è½½å¿…è¦çš„ç¯å¢ƒå˜é‡
# åªåŠ è½½é¡¹ç›®ç›¸å…³çš„ç¯å¢ƒå˜é‡ï¼Œé¿å…å…¨å±€profileæ±¡æŸ“

# åŠ è½½é¡¹ç›®ç¯å¢ƒæ–‡ä»¶
if [ -f "$REPO_ROOT/.env" ]; then
    # åªåŠ è½½ä»¥ç‰¹å®šå‰ç¼€å¼€å¤´çš„ç¯å¢ƒå˜é‡ï¼Œé¿å…æ±¡æŸ“
    while IFS='=' read -r key value; do
        # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
        [[ $key =~ ^[[:space:]]*# ]] && continue
        [[ -z $key ]] && continue

        # åªåŠ è½½AIå’ŒGitLabç›¸å…³çš„ç¯å¢ƒå˜é‡
        if [[ $key =~ ^(AI_|GITLAB_|GEMINI_|OPENCODE_|CLAUDECODE_) ]]; then
            export "$key=$value"
        fi
    done < "$REPO_ROOT/.env" 2>/dev/null
fi

# åŠ è½½å…¨å±€CodeRocketé…ç½®
if [ -f "$HOME/.coderocket/env" ]; then
    while IFS='=' read -r key value; do
        [[ $key =~ ^[[:space:]]*# ]] && continue
        [[ -z $key ]] && continue

        if [[ $key =~ ^(AI_|GITLAB_|GEMINI_|OPENCODE_|CLAUDECODE_) ]]; then
            export "$key=$value"
        fi
    done < "$HOME/.coderocket/env" 2>/dev/null
elif [ -f "$HOME/.codereview-cli/env" ]; then   # backward-compat (remove in next major)
    while IFS='=' read -r key value; do
        [[ $key =~ ^[[:space:]]*# ]] && continue
        [[ -z $key ]] && continue
        if [[ $key =~ ^(AI_|GITLAB_|GEMINI_|OPENCODE_|CLAUDECODE_) ]]; then
            export "$key=$value"
        fi
    done < "$HOME/.codereview-cli/env" 2>/dev/null
fi

# å¯¼å…¥AIæœåŠ¡ç®¡ç†å™¨
if [ -f "$REPO_ROOT/lib/ai-service-manager.sh" ]; then
    source "$REPO_ROOT/lib/ai-service-manager.sh"
elif [ -f "$HOME/.coderocket/lib/ai-service-manager.sh" ]; then
    source "$HOME/.coderocket/lib/ai-service-manager.sh"
elif [ -f "$HOME/.codereview-cli/lib/ai-service-manager.sh" ]; then   # backward-compat
    source "$HOME/.codereview-cli/lib/ai-service-manager.sh"
else
    echo "âŒ é”™è¯¯ï¼šAIæœåŠ¡ç®¡ç†å™¨æœªæ‰¾åˆ°"
    exit 1
fi

# æ£€æŸ¥æç¤ºè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
PROMPT_FILE="$REPO_ROOT/prompts/git-commit-review-prompt.md"
if [ ! -f "$PROMPT_FILE" ]; then
    echo "âŒ é”™è¯¯ï¼šæç¤ºè¯æ–‡ä»¶ä¸å­˜åœ¨: $PROMPT_FILE"
    exit 1
fi

# è·å–å½“å‰AIæœåŠ¡
CURRENT_AI_SERVICE=$(get_ai_service)

# æ£€æŸ¥AIæœåŠ¡æ˜¯å¦å¯ç”¨
if ! check_ai_service_available "$CURRENT_AI_SERVICE"; then
    echo "âŒ é”™è¯¯ï¼šAIæœåŠ¡ $CURRENT_AI_SERVICE ä¸å¯ç”¨"
    echo "å®‰è£…å‘½ä»¤: $(get_install_command "$CURRENT_AI_SERVICE")"
    exit 1
fi

# åˆ›å»º review_logs ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
mkdir -p "$REPO_ROOT/review_logs"

echo "ğŸš€ æ­£åœ¨æ‰§è¡Œ commit åçš„ä»£ç å®¡æŸ¥..."
echo "ğŸ“¡ ä½¿ç”¨AIæœåŠ¡: $CURRENT_AI_SERVICE"

# åˆ‡æ¢åˆ°ä»“åº“æ ¹ç›®å½•æ‰§è¡Œ
cd "$REPO_ROOT"

# å‡†å¤‡æ›´æ˜ç¡®çš„æç¤ºè¯
PROMPT="è¯·æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š
1. ä½ æ˜¯ä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œéœ€è¦å¯¹æœ€æ–°çš„ git commit è¿›è¡Œå®¡æŸ¥
2. ä½¿ç”¨ git --no-pager show å‘½ä»¤è·å–æœ€æ–°æäº¤çš„è¯¦ç»†ä¿¡æ¯
3. æ ¹æ®æç¤ºè¯æ–‡ä»¶ä¸­çš„æŒ‡å¯¼è¿›è¡Œå…¨é¢ä»£ç å®¡æŸ¥
4. ç”Ÿæˆå®¡æŸ¥æŠ¥å‘Šå¹¶ä¿å­˜åˆ° review_logs ç›®å½•
5. ä¸è¦è¯¢é—®ç”¨æˆ·ï¼Œç›´æ¥è‡ªä¸»æ‰§è¡Œæ‰€æœ‰æ­¥éª¤
6. è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æµç¨‹ï¼Œè¯·ç›´æ¥å¼€å§‹æ‰§è¡Œ"

if intelligent_ai_review "$CURRENT_AI_SERVICE" "$PROMPT_FILE" "$PROMPT"; then
    echo "ğŸ‘Œ ä»£ç å®¡æŸ¥å®Œæˆ"
    echo "ğŸ“ å®¡æŸ¥æŠ¥å‘Šå·²ä¿å­˜åˆ° $REPO_ROOT/review_logs ç›®å½•"
else
    echo "âŒ ä»£ç å®¡æŸ¥å¤±è´¥ï¼Œä½†ä¸å½±å“æäº¤"
fi